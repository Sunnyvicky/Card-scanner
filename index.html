<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Card Scanner AI - å°ˆæ¥­äººè„ˆç®¡å®¶</title>
    
    <!-- PWA è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Card Scanner">
    <meta name="theme-color" content="#1e3a8a">
    
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cdefs%3E%3ClinearGradient id='bg' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0' stop-color='%231e3a8a'/%3E%3Cstop offset='1' stop-color='%230f172a'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='512' height='512' rx='120' fill='url(%23bg)'/%3E%3Crect x='86' y='156' width='340' height='200' rx='20' fill='white'/%3E%3Crect x='86' y='190' width='340' height='8' fill='%23f59e0b'/%3E%3Ccircle cx='160' cy='256' r='35' fill='%23e2e8f0'/%3E%3Crect x='220' y='236' width='140' height='16' rx='4' fill='%2394a3b8'/%3E%3Crect x='220' y='266' width='100' height='12' rx='3' fill='%23cbd5e1'/%3E%3C/svg%3E">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='120' fill='%231e3a8a'/%3E%3Crect x='86' y='156' width='340' height='200' rx='20' fill='white'/%3E%3Crect x='86' y='190' width='340' height='8' fill='%23f59e0b'/%3E%3C/svg%3E">

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #f8fafc; color: #1e293b; margin: 0; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 10; transform: scaleX(1); }
        @keyframes scan { 0% { top: 0%; opacity: 0; } 50% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        .scan-line { position: absolute; left: 0; width: 100%; height: 2px; background: #f97316; box-shadow: 0 0 10px #f97316; animation: scan 2s linear infinite; }
        .splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8fafc; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
    </style>
</head>
<body>
    <div id="root">
        <div class="splash-screen">
            <div style="width: 64px; height: 64px; background: linear-gradient(135deg, #3b82f6 0%, #0f172a 100%); border-radius: 16px; display: flex; align-items: center; justify-content: center; margin-bottom: 16px; box-shadow: 0 10px 25px -5px rgba(15, 23, 42, 0.4);">
                <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 512 512" fill="none">
                    <rect x="96" y="156" width="320" height="200" rx="24" fill="white"/>
                    <rect x="96" y="190" width="320" height="16" fill="#f97316"/>
                    <circle cx="170" cy="256" r="30" fill="#cbd5e1"/>
                    <rect x="230" y="240" width="120" height="16" rx="4" fill="#94a3b8"/>
                </svg>
            </div>
            <h1 style="font-size: 20px; font-weight: 900; color: #1e293b; font-family: sans-serif; letter-spacing: -0.5px;">CARD SCANNER AI</h1>
            <p style="font-size: 14px; color: #64748b; font-family: sans-serif; margin-top: 8px; letter-spacing: 1px;">äººè„ˆï¼Œæ˜¯æœ€å¥½çš„è³‡ç”¢</p>
        </div>
    </div>

    <script>
        window.onerror = function(message) {
            document.getElementById('root').innerHTML = '<div style="padding:20px;text-align:center;color:red;margin-top:50px;"><h3>å•Ÿå‹•éŒ¯èª¤</h3><p>'+message+'</p><button onclick="localStorage.clear();location.reload()" style="padding:10px;margin-top:10px;background:#3b82f6;color:white;border:none;border-radius:8px;cursor:pointer;">é‡ç½® App</button></div>';
        };
    </script>

    <script type="text/babel">
        const { useState, useRef, useEffect, useMemo, Component } = React;

        const safeLocalStorage = {
            getItem: (key) => { try { return localStorage.getItem(key); } catch { return null; } },
            setItem: (key, value) => { try { localStorage.setItem(key, value); } catch {} },
            removeItem: (key) => { try { localStorage.removeItem(key); } catch {} }
        };

        const DB_NAME = 'CardScannerDB';
        const STORE_NAME = 'cards';
        const DB_VERSION = 1;
        
        const dbUtils = {
            open: () => new Promise((resolve, reject) => {
                try {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    };
                    request.onsuccess = (e) => resolve(e.target.result);
                    request.onerror = (e) => reject(e.target.error);
                } catch(e) { reject(e); }
            }),
            getAll: async () => {
                const db = await dbUtils.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction([STORE_NAME], 'readonly');
                    const req = tx.objectStore(STORE_NAME).getAll();
                    req.onsuccess = () => resolve(req.result);
                    req.onerror = () => reject(req.error);
                });
            },
            put: async (card) => {
                const db = await dbUtils.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction([STORE_NAME], 'readwrite');
                    const req = tx.objectStore(STORE_NAME).put(card);
                    req.onsuccess = () => resolve();
                    req.onerror = () => reject(req.error);
                });
            },
            delete: async (id) => {
                const db = await dbUtils.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction([STORE_NAME], 'readwrite');
                    const req = tx.objectStore(STORE_NAME).delete(id);
                    req.onsuccess = () => resolve();
                    req.onerror = () => reject(req.error);
                });
            },
            clear: async () => {
                const db = await dbUtils.open();
                return new Promise((resolve, reject) => {
                    const tx = db.transaction([STORE_NAME], 'readwrite');
                    const req = tx.objectStore(STORE_NAME).clear();
                    req.onsuccess = () => resolve();
                    req.onerror = () => reject(req.error);
                });
            }
        };

        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false }; }
            static getDerivedStateFromError() { return { hasError: true }; }
            render() {
                if (this.state.hasError) return <div className="h-screen flex items-center justify-center p-6 text-center text-red-600">ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†</div>;
                return this.props.children;
            }
        }

        const Icon = ({ name, size = 20, className = "" }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (!ref.current || !window.lucide) return;
                ref.current.innerHTML = '';
                const i = document.createElement('i');
                i.setAttribute('data-lucide', name);
                ref.current.appendChild(i);
                window.lucide.createIcons({ root: ref.current, nameAttr: 'data-lucide', attrs: { width: size, height: size, class: className } });
            }, [name, size, className]);
            return <span ref={ref} style={{ display: 'inline-flex', alignItems: 'center' }}></span>;
        };

        const compressImage = (file) => new Promise((resolve, reject) => {
            if (!file) return reject("ç„¡æª”æ¡ˆ");
            const url = URL.createObjectURL(file);
            const img = new Image();
            img.src = url;
            img.onload = () => {
                URL.revokeObjectURL(url);
                const canvas = document.createElement('canvas');
                const MAX_SIZE = 800;
                let width = img.width, height = img.height;
                if (width > height && width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                else if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                canvas.width = width; canvas.height = height;
                canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                resolve(canvas.toDataURL('image/jpeg', 0.6));
            };
            img.onerror = reject;
        });

        const CameraScanner = ({ onCapture, onCancel }) => {
            const videoRef = useRef(null);
            const [error, setError] = useState(null);
            
            useEffect(() => {
                let stream = null;
                const startCamera = async () => {
                    try {
                        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
                        if (videoRef.current) { videoRef.current.srcObject = stream; videoRef.current.play().catch(console.error); }
                    } catch (e) { setError("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—: " + e.message); }
                };
                startCamera();
                return () => { if (stream) stream.getTracks().forEach(t => t.stop()); };
            }, []);
            
            const capture = () => {
                if (!videoRef.current) return;
                const video = videoRef.current;
                const canvas = document.createElement("canvas");
                const videoRatio = video.videoWidth / video.videoHeight;
                const displayRatio = video.clientWidth / video.clientHeight;
                let sx = 0, sy = 0, sWidth = video.videoWidth, sHeight = video.videoHeight;
                if (videoRatio > displayRatio) { sWidth = video.videoHeight * displayRatio; sx = (video.videoWidth - sWidth) / 2; }
                else { sHeight = video.videoWidth / displayRatio; sy = (video.videoHeight - sHeight) / 2; }
                const frameW = sWidth * 0.75, frameH = frameW / 1.6;
                const frameX = sx + (sWidth - frameW) / 2, frameY = sy + (sHeight - frameH) / 2;
                canvas.width = Math.min(frameW, 1000); canvas.height = Math.min(frameH, 1000);
                canvas.getContext('2d').drawImage(video, frameX, frameY, frameW, frameH, 0, 0, canvas.width, canvas.height);
                onCapture(canvas.toDataURL("image/jpeg", 0.7));
            };

            return (
                <div className="fixed inset-0 bg-black z-50 flex flex-col">
                    <div className="flex-1 relative">
                        <video ref={videoRef} playsInline muted autoPlay className="w-full h-full object-cover" />
                        {error && <div className="absolute inset-0 flex items-center justify-center text-white bg-black/80 text-center p-4">{error}</div>}
                        <div className="absolute inset-0 flex items-center justify-center pointer-events-none z-20">
                            <div className="w-3/4 aspect-[1.6/1] border-2 border-blue-500 rounded-xl relative shadow-[0_0_0_999px_rgba(0,0,0,0.5)]">
                                <div className="scan-line"></div>
                                <div className="absolute top-0 left-0 w-4 h-4 border-t-4 border-l-4 border-blue-500 -mt-1 -ml-1"></div>
                                <div className="absolute top-0 right-0 w-4 h-4 border-t-4 border-r-4 border-blue-500 -mt-1 -mr-1"></div>
                                <div className="absolute bottom-0 left-0 w-4 h-4 border-b-4 border-l-4 border-blue-500 -mb-1 -ml-1"></div>
                                <div className="absolute bottom-0 right-0 w-4 h-4 border-b-4 border-r-4 border-blue-500 -mb-1 -mr-1"></div>
                            </div>
                        </div>
                        <div className="absolute bottom-32 w-full text-center z-20"><span className="px-4 py-2 bg-black/50 text-white text-xs rounded-full">è«‹å°‡åç‰‡æ”¾å…¥æ¡†å…§</span></div>
                    </div>
                    <div className="h-32 bg-black flex items-center justify-center gap-8 z-30">
                        <button onClick={onCancel} className="text-white font-bold p-4">å–æ¶ˆ</button>
                        <button onClick={capture} className="w-16 h-16 bg-white rounded-full border-4 border-gray-300 active:scale-95 transition-transform"></button>
                        <div className="w-12"></div>
                    </div>
                </div>
            );
        };

        function App() {
            const [showSplash, setShowSplash] = useState(true);
            const [view, setView] = useState("home");
            const [cards, setCards] = useState([]);
            const [capturedImage, setCapturedImage] = useState(null);
            const [currentAvatar, setCurrentAvatar] = useState(null);
            const [additionalImage, setAdditionalImage] = useState(null);
            const [backImage, setBackImage] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            const [resultData, setResultData] = useState({});
            const [currentCardId, setCurrentCardId] = useState(null);
            const [filterCategory, setFilterCategory] = useState("å…¨éƒ¨");
            const [apiKey, setApiKey] = useState(() => safeLocalStorage.getItem("cardscanner_api_key") || "");
            const [error, setError] = useState(null);
            const [statusMsg, setStatusMsg] = useState("è™•ç†ä¸­...");
            const [searchQuery, setSearchQuery] = useState("");

            useEffect(() => {
                setTimeout(() => setShowSplash(false), 2000);
            }, []);

            useEffect(() => {
                const loadCards = async () => {
                    try {
                        const dbCards = await dbUtils.getAll();
                        setCards(dbCards.sort((a, b) => b.id - a.id));
                    } catch (err) { console.error(err); }
                };
                loadCards();
            }, []);

            useEffect(() => {
                setTimeout(() => { if (window.lucide) window.lucide.createIcons(); }, 50);
            }, [view, cards, resultData, filterCategory]);

            const handleScanCapture = (base64) => {
                setCapturedImage(base64);
                setView("home");
                analyze(base64);
            };

            const analyze = async (base64) => {
                setIsProcessing(true);
                setError(null);
                
                // ä½¿ç”¨ v1 APIï¼ˆä¸æ˜¯ v1betaï¼‰
                const API_URL = "https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent";
                
                try {
                    setStatusMsg("AI è¾¨è­˜ä¸­...");
                    
                    const response = await fetch(`${API_URL}?key=${apiKey.trim()}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    {
                                        text: `åˆ†æåç‰‡ä¸¦ä»¥JSONæ ¼å¼å›å‚³: {"name":"","jobTitle":"","company":"","mobile":"","tel":"","fax":"","email":"","address":"","category":"å·¥ä½œ","note":""}
è¦å‰‡: 1.åªå›å‚³JSON 2.é›»è©±åˆ†é¡mobile(æ‰‹æ©Ÿ)ã€tel(å¸‚è©±)ã€fax(å‚³çœŸ) 3.categoryé¸å·¥ä½œ/å®¶äºº/åŒå­¸/æœ‹å‹`
                                    },
                                    {
                                        inlineData: {
                                            mimeType: "image/jpeg",
                                            data: base64.split(',')[1]
                                        }
                                    }
                                ]
                            }]
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        const errorMsg = errorData.error?.message || `API éŒ¯èª¤ (${response.status})`;
                        
                        if (response.status === 400 && errorMsg.includes('API key')) {
                            throw new Error("API Key ç„¡æ•ˆï¼Œè«‹åˆ°è¨­å®šé é¢æª¢æŸ¥");
                        }
                        
                        if (response.status === 404) {
                            throw new Error("æ¨¡å‹ä¸å¯ç”¨ï¼Œè«‹ç¢ºèª API Key æ¬Šé™");
                        }
                        
                        throw new Error(errorMsg);
                    }

                    const data = await response.json();
                    
                    if (!data.candidates?.[0]?.content?.parts?.[0]?.text) {
                        throw new Error("AI å›æ‡‰æ ¼å¼éŒ¯èª¤");
                    }

                    let text = data.candidates[0].content.parts[0].text;
                    text = text.replace(/```json|```/g, '').trim();
                    const start = text.indexOf('{'), end = text.lastIndexOf('}');
                    
                    if (start === -1 || end === -1) {
                        throw new Error("ç„¡æ³•è§£æ AI å›æ‡‰");
                    }
                    
                    const jsonData = JSON.parse(text.substring(start, end + 1));
                    
                    setResultData({ ...jsonData, category: jsonData.category || "å·¥ä½œ" });
                    setCurrentCardId(null);
                    setCurrentAvatar(null);
                    setBackImage(null);
                    setAdditionalImage(null);
                    setView("result");
                    
                } catch (err) {
                    console.error("Analysis error:", err);
                    
                    const shouldManual = confirm(
                        `âŒ AI è¾¨è­˜å¤±æ•—\n\néŒ¯èª¤: ${err.message}\n\næ˜¯å¦æ”¹ç”¨æ‰‹å‹•è¼¸å…¥ï¼Ÿ\nï¼ˆç…§ç‰‡æœƒä¿ç•™ï¼‰`
                    );
                    
                    if (shouldManual) {
                        setResultData({ category: "å·¥ä½œ" });
                        setCurrentCardId(null);
                        setCurrentAvatar(null);
                        setBackImage(null);
                        setAdditionalImage(null);
                        setView("result");
                    } else {
                        setCapturedImage(null);
                        setView("home");
                    }
                } finally {
                    setIsProcessing(false);
                }
            };

            const testAPIKey = async () => {
                if (!apiKey) { alert("è«‹å…ˆè¼¸å…¥ API Key"); return; }
                
                setIsProcessing(true);
                setStatusMsg("æ¸¬è©¦ API Key...");
                
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${apiKey.trim()}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: "test" }] }]
                        })
                    });

                    if (response.ok) {
                        alert("âœ… API Key æœ‰æ•ˆï¼å¯ä»¥é–‹å§‹ä½¿ç”¨");
                    } else if (response.status === 400) {
                        alert("âŒ API Key ç„¡æ•ˆæˆ–æ ¼å¼éŒ¯èª¤");
                    } else if (response.status === 404) {
                        alert("âŒ æ¨¡å‹ä¸å¯ç”¨ï¼Œè«‹ç¢ºèª API Key æ¬Šé™");
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        alert(`âŒ æ¸¬è©¦å¤±æ•—: ${errorData.error?.message || response.status}`);
                    }
                } catch (err) {
                    alert(`âŒ ç¶²è·¯éŒ¯èª¤: ${err.message}`);
                } finally {
                    setIsProcessing(false);
                }
            };

            const saveCard = async () => {
                const newData = {
                    id: currentCardId || Date.now(),
                    ...resultData,
                    image: capturedImage,
                    backImage: backImage,
                    avatar: currentAvatar,
                    additionalImage: additionalImage,
                    category: resultData.category || "å·¥ä½œ"
                };
                
                try {
                    await dbUtils.put(newData);
                    if (currentCardId) setCards(prev => prev.map(c => c.id === currentCardId ? newData : c));
                    else setCards(prev => [newData, ...prev]);
                    setView("home");
                } catch (e) { alert("å„²å­˜å¤±æ•—"); }
            };

            const handleDeleteCard = async (id, e) => {
                e.stopPropagation();
                if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) {
                    try { await dbUtils.delete(id); setCards(prev => prev.filter(c => c.id !== id)); } catch {}
                }
            };

            const handleImageUpload = async (e, setter) => {
                if (e.target.files[0]) {
                    try { setter(await compressImage(e.target.files[0])); } catch { alert("åœ–ç‰‡è™•ç†å¤±æ•—"); }
                }
            };

            const viewSavedCard = (card) => {
                setResultData(card);
                setCapturedImage(card.image);
                setBackImage(card.backImage || null);
                setCurrentAvatar(card.avatar);
                setAdditionalImage(card.additionalImage || null);
                setCurrentCardId(card.id);
                setView("result");
            };

            const filteredCards = useMemo(() => {
                let result = filterCategory === "å…¨éƒ¨" ? cards : cards.filter(c => c.category === filterCategory);
                if (searchQuery) {
                    const q = searchQuery.toLowerCase();
                    result = result.filter(c => (c.name?.toLowerCase().includes(q)) || (c.company?.toLowerCase().includes(q)));
                }
                return result;
            }, [cards, filterCategory, searchQuery]);

            const exportData = () => {
                if (cards.length === 0) { alert("ç„¡è³‡æ–™"); return; }
                const blob = new Blob([JSON.stringify(cards, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `cardscanner_${Date.now()}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            const importData = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (Array.isArray(data) && confirm(`åŒ¯å…¥ ${data.length} ç­†ï¼Ÿ`)) {
                            for (const card of data) await dbUtils.put(card);
                            setCards((await dbUtils.getAll()).sort((a, b) => b.id - a.id));
                            alert("åŒ¯å…¥æˆåŠŸ");
                        }
                    } catch { alert("æ ¼å¼éŒ¯èª¤"); }
                };
                reader.readAsText(file);
                e.target.value = '';
            };

            if (showSplash) {
                return (
                    <div className="fixed inset-0 bg-[#f8fafc] z-[9999] flex flex-col items-center justify-center">
                        <div style={{ width: '64px', height: '64px', background: 'linear-gradient(135deg, #3b82f6 0%, #0f172a 100%)', borderRadius: '16px', display: 'flex', alignItems: 'center', justifyContent: 'center', marginBottom: '16px', boxShadow: '0 10px 25px -5px rgba(15, 23, 42, 0.4)' }}>
                            <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" fill="none"><rect x="96" y="156" width="320" height="200" rx="24" fill="white"/><rect x="96" y="190" width="320" height="16" fill="#f97316"/><circle cx="170" cy="256" r="30" fill="#cbd5e1"/></svg>
                        </div>
                        <h1 style={{ fontSize: '20px', fontWeight: '900', color: '#1e293b' }}>CARD SCANNER AI</h1>
                        <p style={{ fontSize: '14px', color: '#64748b', marginTop: '8px' }}>äººè„ˆï¼Œæ˜¯æœ€å¥½çš„è³‡ç”¢</p>
                    </div>
                );
            }

            return (
                <div className="max-w-md mx-auto h-screen bg-gray-50 flex flex-col">
                    <header className="px-6 pt-12 pb-4 bg-white shadow-sm flex justify-between items-center">
                        <h1 className="text-xl font-black text-blue-600">CARD SCANNER</h1>
                        <button onClick={() => setView("settings")} className="text-gray-400"><Icon name="settings" /></button>
                    </header>

                    <main className="flex-1 overflow-y-auto p-4">
                        {error && <div className="bg-red-100 text-red-600 p-3 rounded-lg mb-4 text-xs">{error}</div>}

                        {view === "home" && (
                            <div className="space-y-4">
                                {!apiKey && <div onClick={() => setView("settings")} className="bg-blue-50 p-4 rounded-xl text-blue-600 text-center text-sm font-bold cursor-pointer animate-pulse">ğŸ‘‰ è«‹å…ˆè¨­å®š API Key</div>}
                                
                                <div className="relative">
                                    <div className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"><Icon name="search" size={16} /></div>
                                    <input type="text" placeholder="æœå°‹..." className="w-full bg-white border rounded-xl pl-10 pr-4 py-3 text-sm" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />
                                </div>

                                <div className="flex gap-2 overflow-x-auto hide-scrollbar">
                                    {["å…¨éƒ¨", "å·¥ä½œ", "å®¶äºº", "åŒå­¸", "æœ‹å‹"].map(cat => (
                                        <button key={cat} onClick={() => setFilterCategory(cat)} className={`px-4 py-1.5 rounded-full text-xs font-bold whitespace-nowrap ${filterCategory === cat ? "bg-blue-600 text-white" : "bg-white text-gray-500 border"}`}>{cat}</button>
                                    ))}
                                </div>

                                {filteredCards.length === 0 ? (
                                    <div className="text-center py-20 text-gray-400">æš«ç„¡åç‰‡</div>
                                ) : (
                                    filteredCards.map(c => (
                                        <div key={c.id} onClick={() => viewSavedCard(c)} className="bg-white rounded-xl p-4 shadow-sm flex gap-4 items-center active:scale-95 transition">
                                            {c.avatar ? <img src={c.avatar} className="w-12 h-12 rounded-full object-cover" /> : <div className="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center font-bold text-blue-600">{c.name?.[0] || "?"}</div>}
                                            <div className="flex-1 min-w-0">
                                                <div className="font-bold truncate">{c.name || "æœªå‘½å"}</div>
                                                <div className="text-xs text-gray-500 truncate">{c.company || c.jobTitle || "ç„¡å…¬å¸"}</div>
                                            </div>
                                            <button onClick={(e) => handleDeleteCard(c.id, e)} className="text-gray-300 hover:text-red-500"><Icon name="trash-2" size={16} /></button>
                                        </div>
                                    ))
                                )}
                            </div>
                        )}

                        {view === "settings" && (
                            <div className="space-y-4">
                                <div className="bg-white p-5 rounded-xl shadow-sm">
                                    <h3 className="font-bold mb-3">API è¨­å®š</h3>
                                    <p className="text-xs text-gray-500 mb-2">è¼¸å…¥ Gemini API Key</p>
                                    <input type="password" value={apiKey} onChange={(e) => { setApiKey(e.target.value); safeLocalStorage.setItem("cardscanner_api_key", e.target.value); }} className="w-full bg-gray-50 border rounded-lg p-3 text-sm mb-3" placeholder="AIzaSy..." />
                                    <div className="flex gap-2 mb-2">
                                        <button onClick={testAPIKey} className="flex-1 bg-blue-100 text-blue-700 py-2 rounded-lg text-sm font-bold">æ¸¬è©¦ API Key</button>
                                        <button onClick={() => window.open("https://aistudio.google.com/app/apikey", "_blank")} className="flex-1 bg-gray-100 text-gray-600 py-2 rounded-lg text-sm font-bold">å–å¾— Key</button>
                                    </div>
                                </div>
                                
                                <div className="bg-white p-5 rounded-xl shadow-sm">
                                    <h3 className="font-bold mb-3">è³‡æ–™ç®¡ç†</h3>
                                    <div className="space-y-2">
                                        <button onClick={exportData} className="w-full bg-gray-50 p-3 rounded-lg text-left flex justify-between"><span>åŒ¯å‡ºå‚™ä»½</span><Icon name="upload" size={18} /></button>
                                        <label className="w-full bg-gray-50 p-3 rounded-lg flex justify-between cursor-pointer"><span>åŒ¯å…¥å‚™ä»½</span><Icon name="download" size={18} /><input type="file" accept=".json" onChange={importData} className="hidden" /></label>
                                        <button onClick={async () => { if (confirm("ç¢ºå®šæ¸…ç©ºï¼Ÿ")) { await dbUtils.clear(); setCards([]); alert("å·²æ¸…ç©º"); } }} className="w-full bg-red-50 text-red-600 p-3 rounded-lg">æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
                                    </div>
                                </div>
                                
                                <button onClick={() => setView("home")} className="w-full bg-gray-200 text-gray-700 py-3 rounded-xl font-bold">è¿”å›</button>
                            </div>
                        )}

                        {view === "result" && (
                            <div className="bg-white rounded-xl shadow-sm overflow-hidden">
                                <div className="bg-gray-100 relative group">
                                    {capturedImage ? <img src={capturedImage} className="w-full object-contain max-h-64" /> : <div className="h-40 flex items-center justify-center text-gray-400">ç„¡åœ–ç‰‡</div>}
                                </div>
                                
                                <div className="p-5 space-y-4">
                                    <div className="flex gap-4">
                                        <div className="relative">
                                            {currentAvatar ? <img src={currentAvatar} className="w-20 h-20 rounded-xl object-cover" /> : <div className="w-20 h-20 rounded-xl bg-gray-100 flex items-center justify-center"><Icon name="user" size={32} className="text-gray-300" /></div>}
                                            <label className="absolute -bottom-2 -right-2 bg-white shadow-md p-1.5 rounded-full cursor-pointer"><Icon name="edit-2" size={12} className="text-blue-500" /><input type="file" accept="image/*" className="hidden" onChange={(e) => handleImageUpload(e, setCurrentAvatar)} /></label>
                                        </div>
                                        <div className="flex-1 space-y-2">
                                            <input type="text" value={resultData.name || ""} onChange={(e) => setResultData({...resultData, name: e.target.value})} placeholder="å§“å" className="w-full text-xl font-black bg-transparent border-b focus:border-blue-500 outline-none" />
                                            <input type="text" value={resultData.jobTitle || ""} onChange={(e) => setResultData({...resultData, jobTitle: e.target.value})} placeholder="è·ç¨±" className="w-full text-sm text-gray-500 bg-transparent border-b focus:border-blue-500 outline-none" />
                                        </div>
                                    </div>

                                    <div className="space-y-3">
                                        {[
                                            { icon: "building", key: "company", placeholder: "å…¬å¸" },
                                            { icon: "smartphone", key: "mobile", placeholder: "æ‰‹æ©Ÿ" },
                                            { icon: "phone", key: "tel", placeholder: "é›»è©±" },
                                            { icon: "mail", key: "email", placeholder: "Email" },
                                            { icon: "map-pin", key: "address", placeholder: "åœ°å€" },
                                        ].map(f => (
                                            <div key={f.key} className="flex items-center gap-3 bg-gray-50 p-3 rounded-xl">
                                                <Icon name={f.icon} className="text-gray-400" size={18} />
                                                <input type="text" value={resultData[f.key] || ""} onChange={(e) => setResultData({...resultData, [f.key]: e.target.value})} placeholder={f.placeholder} className="flex-1 bg-transparent text-sm outline-none" />
                                            </div>
                                        ))}
                                        
                                        <div className="flex gap-2">
                                            {["å·¥ä½œ", "å®¶äºº", "åŒå­¸", "æœ‹å‹"].map(c => (
                                                <button key={c} onClick={() => setResultData({...resultData, category: c})} className={`flex-1 py-2 text-xs rounded-lg font-bold ${resultData.category === c ? "bg-blue-50 text-blue-600" : "bg-gray-100 text-gray-400"}`}>{c}</button>
                                            ))}
                                        </div>
                                    </div>

                                    <div className="flex gap-3 pt-4">
                                        <button onClick={() => setView("home")} className="flex-1 py-3 rounded-xl font-bold bg-gray-100">å–æ¶ˆ</button>
                                        <button onClick={saveCard} className="flex-1 py-3 rounded-xl font-bold text-white bg-blue-600">å„²å­˜</button>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    {view === "home" && (
                        <div className="absolute bottom-6 left-0 w-full flex justify-center z-20 pointer-events-none">
                            <div className="flex gap-6 bg-white px-6 py-3 rounded-full shadow-xl pointer-events-auto">
                                <button onClick={() => { if (!apiKey) { setView("settings"); return; } setView("scan"); }} className="relative -top-6">
                                    <div className="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center shadow-lg border-4 border-white">
                                        <Icon name="scan-line" size={32} className="text-white" />
                                    </div>
                                </button>
                                <button onClick={() => { setResultData({ category: "å·¥ä½œ" }); setCapturedImage(null); setView("result"); }} className="flex flex-col items-center gap-1 text-gray-400">
                                    <div className="w-10 h-10 rounded-full bg-gray-50 flex items-center justify-center"><Icon name="edit" size={20} /></div>
                                    <span className="text-[10px] font-bold">æ‰‹å‹•</span>
                                </button>
                            </div>
                        </div>
                    )}

                    {view === "scan" && <CameraScanner onCapture={handleScanCapture} onCancel={() => setView("home")} />}

                    {isProcessing && (
                        <div className="fixed inset-0 bg-white/90 z-50 flex flex-col items-center justify-center">
                            <div className="w-16 h-16 border-4 border-blue-100 border-t-blue-600 rounded-full animate-spin mb-4"></div>
                            <div className="text-blue-900 font-bold">{statusMsg}</div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>
